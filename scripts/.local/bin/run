#!/bin/bash

set -eu

[[ "$(uname)" == "Darwin" && "$(uname -m)" == "arm64" ]] || exit 0

[[ ! -d /opt/homebrew ]] && /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

SRC="$HOME/src/zx"

[[ ! -d "$SRC" ]] && git clone https://github.com/tnxz/zx "$SRC"

eval "$(/opt/homebrew/bin/brew shellenv)"

[[ ! -x /opt/homebrew/bin/stow ]] && brew install stow

(
  cd "$SRC"

  stow \
    --target="$HOME" \
    --verbose \
    --no-folding \
    */
)

brew bundle --verbose --zap --cleanup --file "$SRC/homebrew/.Brewfile"
